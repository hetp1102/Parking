{% extends 'base.html' %}
{% block content %}

<style>
/* Full screen overlay for success / error */
.overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  font-weight: bold;
  color: white;
  z-index: 9999;
}

.overlay.success { background: #00c853; }  /* Green */
.overlay.error   { background: #d50000; }  /* Red */
</style>

<div class="overlay success" id="successOverlay">✅ VERIFIED</div>
<div class="overlay error" id="errorOverlay">❌ INVALID QR</div>

<div class="card slide-up">
  <h2>Staff Scanner (Auto QR Scanner)</h2>

  {% if message %}
    <p>{{ message }}</p>
  {% endif %}

  <div id="reader" style="width:100%; max-width:400px; margin:auto;"></div>

  <form method="post" id="scanForm">
    {% csrf_token %}
    <input type="hidden" name="code" id="codeInput">
  </form>

  <p>Point the camera at the user's QR. It will auto-verify.</p>
</div>

<!-- Beep Sound -->
<audio id="beepSound">
  <source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg">
</audio>

<!-- QR Scanner Library -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let lastScanned = null;

function showSuccess() {
  document.getElementById("successOverlay").style.display = "flex";
  document.getElementById("beepSound").play();
  setTimeout(() => {
    document.getElementById("successOverlay").style.display = "none";
  }, 1500);
}

function showError() {
  document.getElementById("errorOverlay").style.display = "flex";
  setTimeout(() => {
    document.getElementById("errorOverlay").style.display = "none";
  }, 1500);
}

function onScanSuccess(decodedText, decodedResult) {
  // Prevent scanning same QR repeatedly
  if (decodedText === lastScanned) return;
  lastScanned = decodedText;

  // Put code in hidden input
  document.getElementById("codeInput").value = decodedText;

  // Auto submit form
  document.getElementById("scanForm").submit();

  // Show success animation + beep (actual validation happens in backend)
  showSuccess();

  // Allow scanning again after 3 seconds
  setTimeout(() => { lastScanned = null; }, 3000);
}

let html5QrcodeScanner = new Html5QrcodeScanner(
  "reader",
  { fps: 10, qrbox: 250 }
);
html5QrcodeScanner.render(onScanSuccess);
</script>

{% endblock %}